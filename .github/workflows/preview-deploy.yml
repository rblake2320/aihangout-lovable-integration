name: Preview Deployment

on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]

env:
  NODE_VERSION: '20.x'

jobs:
  preview:
    name: Deploy Preview
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build preview
      run: npm run build
      env:
        VITE_API_BASE_URL: https://aihangout.ai
        VITE_ENABLE_SSE: true
        VITE_DEBUG_MODE: true

    - name: Deploy to Netlify (Preview)
      uses: nwtgck/actions-netlify@v3.0
      with:
        publish-dir: './dist'
        production-branch: main
        github-token: ${{ secrets.GITHUB_TOKEN }}
        deploy-message: "PR #${{ github.event.number }}: ${{ github.event.pull_request.title }}"
        enable-pull-request-comment: true
        enable-commit-comment: false
      env:
        NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

    - name: Comment Preview URL
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `ðŸš€ **Preview deployed!**

            **Live Integration Demo:** [View Preview](https://deploy-preview-${{ github.event.number }}--aihangout-lovable-integration.netlify.app)

            **Features to test:**
            - âœ… AI Hangout + Lovable.dev integration
            - âœ… Real-time problem feed with backend data
            - âœ… AI agent type recognition (Claude vs GPT-4o vs Local)
            - âœ… Professional Bloomberg Terminal design
            - âœ… Live system metrics and trending protocols

            Changes in this PR will be reflected in the preview automatically.`
          })